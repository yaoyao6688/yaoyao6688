<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>正则表达式总结和引起的思考 | Runtest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <meta name="description" content="基础知识前言：最近公司在搞POC和EXP，在看代码的时候发现有的部分已经生疏了，所以又回头总结一下，包括php和Python的具体函数和使用以及漏洞案例 0x01 基础部分字符：. 匹配任意字符除了\n[…] 匹配字符集\d \D匹配数字/非数字\s \S 匹配空白/非空白字符\w \W 匹配单词字符[a-zA-Z0-9]/非单词字符量词：  匹配前一个字符0次或者无限次   匹配前一个字符1次或">
<meta property="og:type" content="article">
<meta property="og:title" content="正则表达式总结和引起的思考">
<meta property="og:url" content="http://yoursite.com/2019/09/22/正则表达式总结和引起的思考/index.html">
<meta property="og:site_name" content="Runtest">
<meta property="og:description" content="基础知识前言：最近公司在搞POC和EXP，在看代码的时候发现有的部分已经生疏了，所以又回头总结一下，包括php和Python的具体函数和使用以及漏洞案例 0x01 基础部分字符：. 匹配任意字符除了\n[…] 匹配字符集\d \D匹配数字/非数字\s \S 匹配空白/非空白字符\w \W 匹配单词字符[a-zA-Z0-9]/非单词字符量词：  匹配前一个字符0次或者无限次   匹配前一个字符1次或">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-09-21T17:27:08.944Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="正则表达式总结和引起的思考">
<meta name="twitter:description" content="基础知识前言：最近公司在搞POC和EXP，在看代码的时候发现有的部分已经生疏了，所以又回头总结一下，包括php和Python的具体函数和使用以及漏洞案例 0x01 基础部分字符：. 匹配任意字符除了\n[…] 匹配字符集\d \D匹配数字/非数字\s \S 匹配空白/非空白字符\w \W 匹配单词字符[a-zA-Z0-9]/非单词字符量词：  匹配前一个字符0次或者无限次   匹配前一个字符1次或">
  
    <link rel="alternate" href="/atom.xml" title="Runtest" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/default-avatar.jpg">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/highlight.css">
  <script>
  let antiquityStorage = window.sessionStorage.getItem('antiquitySessionStorage');
  if (antiquityStorage == '' || antiquityStorage == null) {
    var antiquityLoader = '<div id="loaderbox"><div class="loader"><div class="load-roll"><div class="load-top"></div><div class="load-right"></div><div class="load-bottom"></div></div></div></div>';
    document.write(antiquityLoader);
    document.body.style.overflow = 'hidden'
  }
  </script>
</head>
</html>
<body>
  <div id="fullpage" class="mobile-nav-right">
    
      <div id="wrapper" style="background-image: url(/images/test.jpg)" title="为了更安全的互联网">
    
    
      <header id="header">
  <div id="nav-toggle" class="nav-toggle"></div>
  <div class="head-box global-width">
    <nav class="nav-box nav-right">
      
        <a class="nav-item" href="/" title
        
        >首页</a>
      
        <a class="nav-item" href="/archives" title
        
        >归档</a>
      
    </nav>
  </div>
</header>
      <div id="middlecontent" title class="global-width sidebar-right">
        <section id="main"><article id="post-正则表达式总结和引起的思考" class="article global-container article-type-post" itemscope itemprop="blogPost">
  
    <header class="article-header">
      
  
    <h1 class="article-title" itemprop="name">
      正则表达式总结和引起的思考
    </h1>
  

    </header>
  
  <div class="article-meta">
    <a href="/2019/09/22/正则表达式总结和引起的思考/" class="article-date">
  <time datetime="2019-09-21T17:26:46.000Z" itemprop="datePublished">2019-09-22</time>
</a>
    
    
  </div>
  
    <span id="busuanzi_container_page_pv">
      本文总阅读量<span id="busuanzi_value_page_pv"></span>次
    </span>
  

  <div class="article-inner">
    
    <div class="article-content article-content-cloud" itemprop="articleBody">
      
        <p><strong>基础知识</strong><br><strong>前言：</strong>最近公司在搞POC和EXP，在看代码的时候发现有的部分已经生疏了，所以又回头总结一下，包括php和Python的具体函数和使用以及漏洞案例</p>
<h4 id="0x01-基础部分"><a href="#0x01-基础部分" class="headerlink" title="0x01 基础部分"></a>0x01 基础部分</h4><p>字符：<br>. 匹配任意字符除了\n<br>[…] 匹配字符集<br>\d \D匹配数字/非数字<br>\s \S 匹配空白/非空白字符<br>\w \W 匹配单词字符[a-zA-Z0-9]/非单词字符<br>量词：</p>
<ul>
<li>匹配前一个字符0次或者无限次</li>
</ul>
<ul>
<li>匹配前一个字符1次或者无限次<br>？匹配其哪一个字符0次或者1次<br>{m}/{m,n}匹配其哪一个字符m次或者n次</li>
</ul>
<p>*？/+? /?? 匹配模式变为非贪婪，尽可能少匹配字符<br>^匹配字符串开头<br>$匹配字符串结尾<br>\A/\Z指定的字符串匹配必须出现在开头/结尾</p>
<h4 id="0x02-Python"><a href="#0x02-Python" class="headerlink" title="0x02 Python"></a>0x02 Python</h4><p>re.findall(“”,) 使用<br>re.findall(“”,)匹配所有<br>re.search(“”,)匹配一次</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">In [1]: import re                                                               </span><br><span class="line"></span><br><span class="line">In [2]: a= &apos;C|Java|Pythonn|Javascript&apos;                                          </span><br><span class="line"></span><br><span class="line">In [3]: r =  re.findall(&quot;Python&quot;,a)</span><br><span class="line">In [5]: r                                                                       </span><br><span class="line">Out[5]: [&apos;Python&apos;]</span><br><span class="line"></span><br><span class="line">#匹配数字</span><br><span class="line">In [6]: a = &apos;C54Java433#4564 Python|Java&apos;                                       </span><br><span class="line"></span><br><span class="line">In [7]: r = re.findall(&quot;\d&quot;,a)                                                  </span><br><span class="line"></span><br><span class="line">In [8]: r                                                                       </span><br><span class="line">Out[8]: [&apos;5&apos;, &apos;4&apos;, &apos;4&apos;, &apos;3&apos;, &apos;3&apos;, &apos;4&apos;, &apos;5&apos;, &apos;6&apos;, &apos;4&apos;]</span><br><span class="line">In [31]: r = re.findall(&quot;\d+&quot;,a) </span><br><span class="line">In [32]: r                                                                      </span><br><span class="line">Out[32]: [&apos;54&apos;, &apos;433&apos;, &apos;4564&apos;]</span><br><span class="line">#匹配非单词字符</span><br><span class="line">In [21]: r = re.findall(&quot;\W&quot;,a)                                                 </span><br><span class="line"></span><br><span class="line">In [22]: r                                                                      </span><br><span class="line">Out[22]: [&apos;#&apos;, &apos; &apos;, &apos;|&apos;]</span><br></pre></td></tr></table></figure></div>

<p>用正则表达式匹配url<br>图片处’img src=”(.*?)”‘</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">In [9]: url = &quot;http://www.xiaohuar.com/2014.html&quot;                               </span><br><span class="line"></span><br><span class="line">In [10]: res=req.get(url)                                                       </span><br><span class="line"></span><br><span class="line">In [11]: url = re.findall(&apos;img src=&quot;(.*?)&quot;&apos;,res.text)                           </span><br><span class="line"></span><br><span class="line">In [12]: url                                                                    </span><br><span class="line">Out[12]: </span><br><span class="line">[&apos;/d/file/20160316/a0bab5b5cc4f695012f4af1d871e7256.jpg&apos;,</span><br><span class="line"> &apos;http://www.xiaohuar.com/d/file/20140811101923185.jpg&apos;]</span><br><span class="line"> ……</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> In [13]: for i in url: </span><br><span class="line">    ...:     if i.startswith(&apos;/d&apos;): </span><br><span class="line">    ...:         i=&quot;http://www.xiaohuar.com&quot;+i </span><br><span class="line">    ...:     print(i) </span><br><span class="line">    ...:                                                                        </span><br><span class="line">http://www.xiaohuar.com/d/file/20160316/a0bab5b5cc4f695012f4af1d871e7256.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/20140811101923185.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/2b903e6d59bd1435a0b9ddfb5b4bd9c5.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/20190814/5c01302d1d3e7f2fc6cbafbc19becaa8.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/20161018/5385b7113046ac9ae560da41a44b12af.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/2ce538e9658af40bc034f5dfaf57826a.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/20141116030511162.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/faf429bf24391374472fec693322b178.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/20151206/f391a2312f448863f36db7d0d9acb84d.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/7249c06c326a75800fdb9a0e1d4c0df8.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/20140916055435171.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/20151109/a6a9f1cd6c721bb3fb1dfe6094a6eeb4.jpg</span><br></pre></td></tr></table></figure></div>

<p>当然可以使用解析库去解析如bs4</p>
<h4 id="0x03-php"><a href="#0x03-php" class="headerlink" title="0x03 php"></a>0x03 php</h4><p>引用W3schoool</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">echo str_replace(&quot;world&quot;,&quot;Shanghai&quot;,&quot;Hello world!&quot;);</span><br><span class="line">?&gt;</span><br><span class="line">  </span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">运行结果</span><br><span class="line">Hello Shanghai!</span><br></pre></td></tr></table></figure></div>

<p>preg_match() 函数用于进行正则表达式匹配，成功返回 1 ，否则返回 0 。</p>
<p>语法：<br>int preg_match( string pattern, string subject [, array matches ] )<br>看seebug上大佬的某处代码审计案例解析</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">public function upload() &#123;</span><br><span class="line"></span><br><span class="line">     // 创建图片存储文件夹</span><br><span class="line">     $dir = SYS_UPLOAD_PATH.&apos;/member/&apos;.$this-&gt;uid.&apos;/&apos;;</span><br><span class="line">     @dr_dir_delete($dir);</span><br><span class="line">     !is_dir($dir) &amp;&amp; dr_mkdirs($dir);</span><br><span class="line"></span><br><span class="line">     if ($_POST[&apos;tx&apos;]) &#123;</span><br><span class="line">         $file = str_replace(&apos; &apos;, &apos;+&apos;, $_POST[&apos;tx&apos;]);</span><br><span class="line">         if (preg_match(&apos;/^(data:\s*image\/(\w+);base64,)/&apos;, $file, $result))&#123;</span><br><span class="line">             $new_file = $dir.&apos;0x0.&apos;.$result[2];</span><br><span class="line">             if (!@file_put_contents($new_file, base64_decode(str_replace($result[1], &apos;&apos;, $file)))) &#123;</span><br><span class="line">                 exit(dr_json(0, &apos;目录权限不足或磁盘已满&apos;));</span><br><span class="line">             &#125; else &#123;</span><br><span class="line">                 $this-&gt;load-&gt;library(&apos;image_lib&apos;);</span><br><span class="line">                 $config[&apos;create_thumb&apos;] = TRUE;</span><br><span class="line">                 $config[&apos;thumb_marker&apos;] = &apos;&apos;;</span><br><span class="line">                 $config[&apos;maintain_ratio&apos;] = FALSE;</span><br><span class="line">                 $config[&apos;source_image&apos;] = $new_file;</span><br><span class="line">                 foreach (array(30, 45, 90, 180) as $a) &#123;</span><br><span class="line">                     $config[&apos;width&apos;] = $config[&apos;height&apos;] = $a;</span><br><span class="line">                     $config[&apos;new_image&apos;] = $dir.$a.&apos;x&apos;.$a.&apos;.&apos;.$result[2];</span><br><span class="line">                     $this-&gt;image_lib-&gt;initialize($config);</span><br><span class="line">                     if (!$this-&gt;image_lib-&gt;resize()) &#123;</span><br><span class="line">                         exit(dr_json(0, &apos;上传错误：&apos;.$this-&gt;image_lib-&gt;display_errors()));</span><br><span class="line">                         break;</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">                 list($width, $height, $type, $attr) = getimagesize($dir.&apos;45x45.&apos;.$result[2]);</span><br><span class="line">                 !$type &amp;&amp; exit(dr_json(0, &apos;图片字符串不规范&apos;));</span><br><span class="line">             &#125;</span><br><span class="line">         &#125; else &#123;</span><br><span class="line"></span><br><span class="line">             exit(dr_json(0, &apos;图片字符串不规范&apos;));</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; else &#123;</span><br><span class="line">         exit(dr_json(0, &apos;图片不存在&apos;));</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure></div>

<p>问题出现preg_match(‘/^(data:\s*image/(\w+);base64,)/‘, $file, $result)处，正则表达式过滤不严格，导致 $result[2]变量可控制为php，而图片内容也可以是可控制的base64编码的部分，所以可以getshell<br>通过简单测试：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$file = &quot;data:image/php;base64,PD9waHAgcGhwaW5mbygpOz8+&quot;;</span><br><span class="line">if(preg_match(&apos;/^(data:\s*image\/(\w+);base64,)/&apos;, $file, $result))&#123;</span><br><span class="line">    print_r($result); </span><br><span class="line">&#125; else &#123;</span><br><span class="line">    print &quot;A match was not found.&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">php test.php 运行结果 </span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; data:image/php;base64,</span><br><span class="line">    [1] =&gt; data:image/php;base64,</span><br><span class="line">    [2] =&gt; php</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>

<p>在php当中，’()’表示匹配的子模式，在代码中的正则用了俩次括号，所以得到数组有十三个<br>此处正确的正则表达式和代码应该为</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$file = &quot;data:image/jpg;base64,PD9waHAgcGhwaW5mbygpOz8+&quot;;</span><br><span class="line">if(preg_match(&apos;/^(data:\s*image\/(jpg|png|jpeg);base64,)/&apos;, $file, $result))&#123;</span><br><span class="line">    print_r($result); </span><br><span class="line">&#125; else &#123;</span><br><span class="line">    print &quot;A match was not found.&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></div>

<p>运行结果：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; data:image/jpg;base64,</span><br><span class="line">    [1] =&gt; data:image/jpg;base64,</span><br><span class="line">    [2] =&gt; jpg</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>

<p>关于php的正则细节可以参考<a href="https://blog.csdn.net/uglyfisher/article/details/79333586" target="_blank" rel="noopener">[https://blog.csdn.net/uglyfisher/article/details/79333586]</a><br>研究正则表达式，可以严谨代码书写规范，挖掘漏洞</p>
<h4 id="0x03-正则表达式引起的CPU过载"><a href="#0x03-正则表达式引起的CPU过载" class="headerlink" title="0x03 正则表达式引起的CPU过载"></a>0x03 正则表达式引起的CPU过载</h4><p>引用一处正则表达式回溯的案例<br><a href="https://www.jb51.net/article/163520.htm" target="_blank" rel="noopener">https://www.jb51.net/article/163520.htm</a></p>

      
    </div>
    
      <footer class="article-footer">
        完
      </footer>
    
  </div>
  
    
<nav id="article-nav">
  <div class="article-nav-block">
    
      <a href="/2019/10/12/Bypass-the-HTML-file-suffix-restriction-when-uploading-files/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption"></strong>
        <div class="article-nav-title">
          
            Bypass the HTML file suffix restriction when uploading files
          
        </div>
      </a>
    
  </div>
  <div class="article-nav-block">
    
      <a href="/2019/09/05/Reflective-xss-on-admin-snippets-php/" id="article-nav-older" class="article-nav-link-wrap">
        <div class="article-nav-title">Reflective xss on admin/snippets.php</div>
        <strong class="article-nav-caption"></strong>
      </a>
    
  </div>
</nav>

    
<div id="gitmentContainer"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
var gitment = new Gitment({
  owner: '',
  repo: '',
  oauth: {
    client_id: '',
    client_secret: '',
  },
})
gitment.render('gitmentContainer')
</script>

  
  
</article>
</section>
        <aside id="sidebar">
  
    <div class="widget-box">
  <div class="avatar-box">
    <img class="avatar" src="/images/code-title.png" title="为了更安全的互联网"></img>
    <h3 class="avatar-name">
      
        泰斯特
      
    </h3>
    <p class="avatar-slogan">
      搬砖工程师。
    </p>
  </div>
</div>


  
    

  
    

  
    
  
    
  <div class="widget-box">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li></ul>
    </div>
  </div>

  
    
  <div class="widget-box">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/02/11/Activity及Intent/">Activity及Intent</a>
          </li>
        
          <li>
            <a href="/2020/02/11/Android布局及控件/">Android布局及控件</a>
          </li>
        
          <li>
            <a href="/2020/02/08/NDK-Build-方式实现JIN/">NDK-Build 方式实现JIN</a>
          </li>
        
          <li>
            <a href="/2020/01/29/hadoop-伪分布式/">hadoop 伪分布式</a>
          </li>
        
          <li>
            <a href="/2020/01/12/深入剖析代审的线程安全问题/">深入剖析代审的线程安全问题</a>
          </li>
        
      </ul>
    </div>
  </div>

  
      <div class="widget-box">
    <h3 class="widget-title">友链</h3>
    <div class="widget">
      
        <a style="display: block;" href="https://blog.ssssdl.xyz/" title target='_blank'
        >ssssdl</a>
      
        <a style="display: block;" href="https://lingwu111.github.io/" title target='_blank'
        >lingwu</a>
      
        <a style="display: block;" href="http://blog.0xccc.cc/" title target='_blank'
        >canxiao</a>
      
        <a style="display: block;" href="http://www.vkxss.top/" title target='_blank'
        >Vk</a>
      
        <a style="display: block;" href="https://syst1m.com/" title target='_blank'
        >syst1m</a>
      
    </div>
  </div>

  
</aside>
      </div>
      <footer id="footer">
  <div class="foot-box global-width">
    &copy; 2020 test &nbsp;&nbsp;
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    &nbsp;|&nbsp;主题 <a href="https://github.com/yiluyanxia/hexo-theme-antiquity">antiquity</a>
    <br>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_site_pv">不蒜子告之   阁下是第<span id="busuanzi_value_site_pv"></span>个访客</span>
  </div>
</footer>
      <script src="https://code.jquery.com/jquery-2.0.3.min.js"></script>
<script>
if (!window.jQuery) {
var script = document.createElement('script');
script.src = "/js/jquery-2.0.3.min.js";
document.body.write(script);
}
</script>

  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



    </div>
    <nav id="mobile-nav" class="mobile-nav-box">
  <div class="mobile-nav-img mobile-nav-top"></div>
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
  <div class="mobile-nav-img  mobile-nav-bottom"></div>
</nav>    
  </div>
</body>
</html>